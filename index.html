<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Morse ðŸ˜º</title>
        <style>
        #feedback {
            width:200px;
            height:200px;
            margin: 0 auto;
            font-weight: bold;
            color: white;
            background-color: #3677b3;
        }
        #feedback.success {
            background-color: #36B37E;
        }
        #feedback.failure {
            background-color: #FF5630;
        }
        #feedback_wrong_character, #feedback_character {
            min-height: 1.25em;
            line-height: 1.25;
            font-variant-caps: small-caps;
            font-size: 50px;
            font-family: sans-serif;
            text-align: center;
        }
        #feedback_wrong_character {
            text-decoration: line-through;
        }
        #feedback_cw {
            font-size: 40px;
            text-align: center;
        }
        </style>
        <script src="./jscwlib.js"></script>
    </head>
    <body>
        <div id="copied"></div>
        <div id="feedback">
            <div id="feedback_wrong_character"></div>
            <div id="feedback_character"></div>
            <div id="feedback_cw"></div>
        </div>
        <div id="lamp" style="width:20px; height:20px; border:1px solid black;"></div>
        <script>
        const charset = ",./0123456789=?abcdefghijklmnopqrstuvwxyz";
        const word_length = 5;

        const freq = 550;
        const error_freq = 200;
        const m = new jscw({"wpm": 20, "eff": 20});

        function push_word() {
            const word = Array.from({length: word_length}, () =>
                charset[Math.floor(Math.random() * charset.length)]
            ).join('');
            m.setText(' ' + word);
        }

        const played = [];
        let nextIndex = 0;
        const copied = document.getElementById('copied');
        const feedback = document.getElementById('feedback');
        const feedback_wrong_character = document.getElementById('feedback_wrong_character');
        const feedback_character = document.getElementById('feedback_character');
        const feedback_cw = document.getElementById('feedback_cw');

        function onFinished() {
            push_word();
            m.play();
        }

        function start() {
            push_word();
            played.length = 0;
            nextIndex = 1;  // skip leading space
            m.setFreq(freq);
            m.onFinished = onFinished;
            m.play();
            feedback.classList.add('success');
            feedback.classList.remove('failure');
            feedback_wrong_character.innerText = '';
            feedback_character.innerText = '';
            feedback_cw.innerText = '';
        }

        function character_to_string(c) {
            if (c === undefined) {
                return '-';
            } else if (c == ' ') {
                return 'Space';
            } else {
                return c;
            }
        }

        document.addEventListener('keydown', function(event) {
            const user_input = event.key.toLowerCase();

            // disable Firefox's quick search when pressing forward slash
            if (user_input == '/') {
                event.preventDefault();
            }

            // hitting space starts the keying
            if (!m.getRemaining()) {
                // not playing
                if (user_input == 'enter') {
                    start();
                }
                return;
            }

            // ignore non-copy user inputs (not in the charset, and not a space)
            if (user_input != ' ' && charset.indexOf(user_input) == -1) {
                return;
            }

            // played[nextIndex] is undefined if nextIndex >= played.length
            const expected = played[nextIndex]?.toLowerCase();
            if (user_input == expected) {
                // correct
                nextIndex += 1;
                copied.innerText = played.slice(0, nextIndex).join('');
            } else {
                // incorrect
                m.onFinished = function() {
                    m.onFinished = undefined;
                    m.setFreq(freq);
                    m.play(expected);
                };
                m.stop();
                m.setFreq(error_freq);
                m.play('T');
                feedback.classList.remove('success');
                feedback.classList.add('failure');
                feedback_wrong_character.innerText = character_to_string(user_input);
            }

            feedback_character.innerText = character_to_string(expected);
            feedback_cw.innerText = m.alphabet[expected] || '';
        })

        m.onCharacterPlay = function(c) {
            played.push(c.c);
        }

        document.body.focus();
        </script>
    </body>
</html>
