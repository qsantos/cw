<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Morse ðŸ˜º</title>
        <style>
        body {
            position: relative;
            margin: 5px 20px;
        }
        h1 {
            font-size: 50px;
            font-family: sans-serif;
            text-align: center;
        }
        nav {
            position: absolute;
            top: 0;
            right: 0;
        }
        nav>img {
            width:50px;
        }
        #stats>table {
            text-align: right;
        }
        #stats>table th {
            width: 140px;
            height: 40px;
        }
        #feedback {
            width:200px;
            height:200px;
            margin: 0 auto;
            font-weight: bold;
            color: white;
            background-color: #3677b3;
            text-align: center;
        }
        #feedback.success {
            background-color: #36B37E;
        }
        #feedback.failure {
            background-color: #FF5630;
        }
        #feedback_wrong_character, #feedback_character {
            min-height: 1.25em;
            line-height: 1.25;
            font-variant-caps: small-caps;
            font-size: 50px;
            font-family: sans-serif;
        }
        #feedback_wrong_character {
            text-decoration: line-through;
        }
        .strike {
            text-decoration: line-through;
            color: red;
        }
        .meta {
            font-size: 15px;
            color: #444;
        }
        #feedback_cw {
            font-size: 40px;
        }
        #settings {
        }
        #history {
            position: relative;
            font-family: monospace;
            font-size: 20px;
            text-transform: uppercase;
            border:1px solid grey;
            height:200px;
            padding: 5px;
            margin: 15px;
            background-color:#fcf8f8;
            list-style: none;
            color: linear-gradient(#f69d3c, #3f87a6);;
            overflow: hidden;
        }
        </style>
        <script src="./jscwlib.js"></script>
    </head>
    <body>
        <h1>Morse ðŸ˜º</h1>
        <nav>
            <img src="ftchart-bar.svg" id="button stats-button" onclick="document.getElementById('stats').showModal()">
            <img src="ftgear.svg" id="button settings-button" onclick="document.getElementById('settings').showModal()">
        </nav>
        <div id="info"></div>
        <div id="feedback" tabindex="1">
            <div id="feedback_wrong_character">&nbsp;</div>
            <div id="feedback_character">&nbsp;</div>
            <div id="feedback_cw">&nbsp;</div>
        </div>
        <div id="lamp" style="width:20px; height:20px; border:1px solid black;"></div>
        <ul id="history"></ul>
        <dialog id="stats"></dialog>
        <dialog id="settings">
            <h3>Settings</h3>
            <label for="settings-wpm">Speed:</label>
            <input id="settings-wpm" oninput="onSettingsChange()" type="number" value="20" min="1" step="0.5" />
            <abbr title="Words Per Minute">WPM</abbr>
            <br>
            <label for="settings-tone">Tone:</label>
            <input id="settings-tone" oninput="onSettingsChange()" type="number" value="600" min="10" step="10" />
            Hz
            <br>
            <label for="settings-error-tone">Error Tone:</label>
            <input id="settings-error-tone" oninput="onSettingsChange()" type="number" value="200" min="10" step="10" />
            Hz
            <br>
            <label for="settings-word-length">Size of words:</label>
            <input id="settings-word-length" oninput="onSettingsChange()" type="number" value="5" min="1" />
            characters
            <br>
            <label for="settings-lcwo-lesson"><a href="https://lcwo.net/" title="Learn CW Online">LCWO</A> Lesson:</label>
            <select id="settings-lcwo-lesson" oninput="onLCWOLessonInput()">
                <option value="0">-</option>
                <option value="1">1 - K, M</option>
                <option value="2">2 - U</option>
                <option value="3">3 - R</option>
                <option value="4">4 - E</option>
                <option value="5">5 - S</option>
                <option value="6">6 - N</option>
                <option value="7">7 - A</option>
                <option value="8">8 - P</option>
                <option value="9">9 - T</option>
                <option value="10">10 - L</option>
                <option value="11">11 - W</option>
                <option value="12">12 - I</option>
                <option value="13">13 - .</option>
                <option value="14">14 - J</option>
                <option value="15">15 - Z</option>
                <option value="16">16 - =</option>
                <option value="17">17 - F</option>
                <option value="18">18 - O</option>
                <option value="19">19 - Y</option>
                <option value="20">20 - ,</option>
                <option value="21">21 - V</option>
                <option value="22">22 - G</option>
                <option value="23">23 - 5</option>
                <option value="24">24 - /</option>
                <option value="25">25 - Q</option>
                <option value="26">26 - 9</option>
                <option value="27">27 - 2</option>
                <option value="28">28 - H</option>
                <option value="29">29 - 3</option>
                <option value="30">30 - 8</option>
                <option value="31">31 - B</option>
                <option value="32">32 - ?</option>
                <option value="33">33 - 4</option>
                <option value="34">34 - 7</option>
                <option value="35">35 - C</option>
                <option value="36">36 - 1</option>
                <option value="37">37 - D</option>
                <option value="38">38 - 6</option>
                <option value="39">39 - 0</option>
                <option value="40">40 - X</option>
            </select>
            <br>
            <label for="settings-charset">Customize Charset:</label>
            <br>
            <textarea id="settings-charset" oninput="onCustomCharsetInput()"></textarea>
            <br>
            <input id="settings-charset-latin" type="checkbox" oninput="onToggleChars(event, latin)">
            <label for="settings-charset-latin"><code>A-Z</code></label>
            <input id="settings-charset-digits" type="checkbox" oninput="onToggleChars(event, digits)">
            <label for="settings-charset-digits"><code>0-9</Code></label>
            <input id="settings-charset-punct" type="checkbox" oninput="onToggleChars(event, punct)">
            <label for="settings-charset-punct"><code>.,:?'-/()"=+Ã—@</code></label>
        </dialog>
        <script>
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';  // A-Z
        const digits = '0123456789';  // 0-9
        const punct = '.,:?\'-/()"=+Ã—@';
        const lcwo_lessons = 'KMURESNAPTLWI.JZ=FOY,VG5/Q92H38B?47C1D60X';
        const settings = JSON.parse(localStorage.getItem('settings')) || {
            wpm: 20,
            tone: 600,
            error_tone: 200,
            word_length: 5,
            charset: lcwo_lessons,
        };
        const history = JSON.parse(localStorage.getItem('history')) || [];

        const m = new jscw();

        function push_word() {
            const word = Array.from({length: settings.word_length}, () =>
                settings.charset[Math.floor(Math.random() * settings.charset.length)]
            ).join('');
            m.setText(' ' + word);
        }

        const played = [];
        let copiedText = '';
        let inSession = false;
        let sessionStart = undefined;
        let sessionDurationUpdater = undefined;

        // stats
        let statsUpdated = localStorage.getItem('statsUpdated');
        // CHARACTERS
        let totalCopiedCharacters = localStorage.getItem('totalCopiedCharacters') ^ 0;
        let sessionCopiedCharacters = localStorage.getItem('sessionCopiedCharacters') ^ 0;
        let dayCopiedCharacters = localStorage.getItem('dayCopiedCharacters') ^ 0;
        let bestSessionCopiedCharacters = localStorage.getItem('bestSessionCopiedCharacters') ^ 0;
        let bestDayCopiedCharacters = localStorage.getItem('bestDayCopiedCharacters') ^ 0;
        // WORDS
        let totalCopiedWords = localStorage.getItem('totalCopiedWords') ^ 0;
        let sessionCopiedWords = localStorage.getItem('sessionCopiedWords') ^ 0;
        let dayCopiedWords = localStorage.getItem('dayCopiedWords') ^ 0;
        let bestSessionCopiedWords = localStorage.getItem('bestSessionCopiedWords') ^ 0;
        let bestDayCopiedWords = localStorage.getItem('bestDayCopiedWords') ^ 0;
        // SCORE
        let totalScore = localStorage.getItem('totalScore') ^ 0;
        let sessionScore = localStorage.getItem('sessionScore') ^ 0;
        let dayScore = localStorage.getItem('dayScore') ^ 0;
        let bestSessionScore = localStorage.getItem('bestSessionScore') ^ 0;
        let bestDayScore = localStorage.getItem('bestDayScore') ^ 0;
        // TIME
        let totalTime = localStorage.getItem('totalTime') ^ 0;
        let sessionTime = localStorage.getItem('sessionTime') ^ 0;
        let dayTime = localStorage.getItem('dayTime') ^ 0;
        let bestSessionTime = localStorage.getItem('bestSessionTime') ^ 0;
        let bestDayTime = localStorage.getItem('bestDayTime') ^ 0;

        const element_history = document.getElementById('history');
        const element_feedback = document.getElementById('feedback');
        const element_feedback_wrong_character = document.getElementById('feedback_wrong_character');
        const element_feedback_character = document.getElementById('feedback_character');
        const element_feedback_cw = document.getElementById('feedback_cw');
        const element_stats = document.getElementById('stats');
        const element_info = document.getElementById('info');

        function onSettingsChange() {
            stop();
            settings.wpm = document.getElementById('settings-wpm').value;
            settings.tone = document.getElementById('settings-tone').value;
            settings.error_tone = document.getElementById('settings-error-tone').value;
            settings.word_length = document.getElementById('settings-word-length').value;
            settings.charset = document.getElementById('settings-charset').value;
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function lcwo_lesson_of_charset(charset) {
            const s = new Set(charset.toUpperCase());
            let i = 0;
            while (i < lcwo_lessons.length) {
                const c = lcwo_lessons[i];
                if (s.has(c)) {
                    s.delete(c);
                } else {
                    break;
                }
                i += 1.
            }
            return s.size == 0 && i > 0 ? i - 1 : 0;
        }

        function updateLCWOLessonFromCharset() {
            const lcwo_lesson = lcwo_lesson_of_charset(settings.charset);
            document.getElementById('settings-lcwo-lesson').value = lcwo_lesson;
        }

        // returns true when setA contains setB
        function contains(setA, setB) {
            return [...setB].every(x => setA.has(x));
        }

        // returns true when setA and setB intersects
        function intersects(setA, setB) {
            return [...setB].some(x => setA.has(x));
        }

        function updateToggleFromCharset(id, chars) {
            const toggleChars = new Set(chars);
            const selectedChars = new Set(settings.charset.toUpperCase());
            const element = document.getElementById(id);
            if (contains(selectedChars, toggleChars)) {
                element.checked = true;
                element.indeterminate = false;
            } else if (intersects(selectedChars, toggleChars)) {
                element.indeterminate = true;
            } else {
                element.checked = false;
                element.indeterminate = false;
            }
        }

        function updateTogglesFromCharset() {
            updateToggleFromCharset('settings-charset-latin', latin);
            updateToggleFromCharset('settings-charset-digits', digits);
            updateToggleFromCharset('settings-charset-punct', punct);
        }

        function onCustomCharsetInput() {
            onSettingsChange();
            updateLCWOLessonFromCharset();
            updateTogglesFromCharset();
        }

        function onLCWOLessonInput() {
            const lcwo_lesson = document.getElementById('settings-lcwo-lesson').value ^ 0;
            if (lcwo_lesson === 0) {
                return;
            }
            document.getElementById('settings-charset').value = lcwo_lessons.slice(0, lcwo_lesson + 1);
            onSettingsChange();
            updateTogglesFromCharset();
        }

        function onToggleChars(event, chars) {
            const s = new Set(chars);
            const charset_without_chars = [...settings.charset].filter(c => !s.has(c.toUpperCase())).join('');
            if (event.target.checked) {
                settings.charset = chars + charset_without_chars;
            } else {
                settings.charset = charset_without_chars;
            }
            document.getElementById('settings-charset').value = settings.charset;
            onSettingsChange();
            updateLCWOLessonFromCharset();
        }

        function restore_settings() {
            document.getElementById('settings-wpm').value = settings.wpm;
            document.getElementById('settings-tone').value = settings.tone;
            document.getElementById('settings-error-tone').value = settings.error_tone;
            document.getElementById('settings-word-length').value = settings.word_length;
            document.getElementById('settings-charset').value = settings.charset;
            updateLCWOLessonFromCharset();
            updateTogglesFromCharset();
        }
        restore_settings();

        function updateStats() {
            // reset day stats when UTC midnight passes
            const now = new Date();
            const today = now.toISOString().slice(0, 10);  // "YYYY-MM-DD"
            if (statsUpdated < today) {
                dayCopiedCharacters = 0;
                localStorage.setItem('dayCopiedCharacters', dayCopiedCharacters);
                dayCopiedWords = 0;
                localStorage.setItem('dayCopiedWOrds', dayCopiedWords);
                dayScore = 0;
                localStorage.setItem('dayScore', dayScore);
                dayTime = 0;
                localStorage.setItem('dayTime', dayTime);
            }
            statsUpdated = now;
            localStorage.setItem('statsUpdated', statsUpdated.toISOString());

            element_stats.innerHTML = `
            <h3>Statistics</h3>
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>Time</th>
                        <th>Characters</th>
                        <th>Words</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>Current Session</th>
                        <td>${sessionTime} s</td>
                        <td>${sessionCopiedCharacters}</td>
                        <td>${sessionCopiedWords}</td>
                        <td>${sessionScore}</td>
                    </tr>
                    <tr>
                        <th>Best Session</th>
                        <td>${bestSessionTime} s</td>
                        <td>${bestSessionCopiedCharacters}</td>
                        <td>${bestSessionCopiedWords}</td>
                        <td>${bestSessionScore}</td>
                    </tr>
                    <tr>
                        <th>Current Day</th>
                        <td>${dayTime} s</td>
                        <td>${dayCopiedCharacters}</td>
                        <td>${dayCopiedWords}</td>
                        <td>${dayScore}</td>
                    </tr>
                    <tr>
                        <th>Best Day</th>
                        <td>${bestDayTime} s</td>
                        <td>${bestDayCopiedCharacters}</td>
                        <td>${bestDayCopiedWords}</td>
                        <td>${bestDayScore}</td>
                    </tr>
                    <tr>
                        <th>Total</th>
                        <td>${totalTime} s</td>
                        <td>${totalCopiedCharacters}</td>
                        <td>${totalCopiedWords}</td>
                        <td>${totalScore}</td>
                    </tr>
                </tbody>
            </table>

            `;
        }
        updateStats();

        function formatHistoryEntry(entry) {
            let ret = `<span class="meta"><time datetime="${entry.started}">${entry.started}</time>:</span> ${entry.copiedText}`;
            if (entry.mistake) {
                const { expected_character, mistaken_character } = entry.mistake;
                ret += `<span class="strike">${mistaken_character}</span>${expected_character}`;
            }
            return '<li>' + ret + '<li>';
        }

        function updateHistory() {
            const entries = history.slice(-10);
            const formattedEntries = [...entries.map(formatHistoryEntry)];
            element_history.innerHTML = '<li>' + copiedText + '</li>' + formattedEntries.reverse().join('');
        }
        updateHistory();

        function incrementCopiedCharacters(c) {
            copiedText += c;

            // CHARACTERS
            // total
            totalCopiedCharacters += 1;
            localStorage.setItem('totalCopiedCharacters', totalCopiedCharacters)
            // session
            sessionCopiedCharacters += 1;
            localStorage.setItem('sessionCopiedCharacters', sessionCopiedCharacters);
            // day
            dayCopiedCharacters += 1;
            localStorage.setItem('dayCopiedCharacters', dayCopiedCharacters)
            // best session
            if (sessionCopiedCharacters > bestSessionCopiedCharacters) {
                bestSessionCopiedCharacters = sessionCopiedCharacters;
                localStorage.setItem('bestSessionCopiedCharacters', bestSessionCopiedCharacters)
            }
            // best day
            if (dayCopiedCharacters > bestDayCopiedCharacters) {
                bestDayCopiedCharacters = dayCopiedCharacters;
                localStorage.setItem('bestDayCopiedCharacters', bestDayCopiedCharacters);
            }

            // WORDS
            if (c == ' ') {
                // total
                totalCopiedWords += 1;
                localStorage.setItem('totalCopiedWords', totalCopiedWords);
                // session
                sessionCopiedWords += 1;
                localStorage.setItem('sessionCopiedWords', sessionCopiedWords);
                // day
                dayCopiedWords += 1;
                localStorage.setItem('dayCopiedWords', dayCopiedWords);
                // best session
                if (sessionCopiedWords > bestSessionCopiedWords) {
                    bestSessionCopiedWords = sessionCopiedWords;
                    localStorage.setItem('bestSessionCopiedWords', bestSessionCopiedWords);
                }
                // best day
                if (dayCopiedWords > bestDayCopiedWords) {
                    bestDayCopiedWords = dayCopiedWords;
                    localStorage.setItem('bestDayCopiedWords', bestDayCopiedWords);
                }
            }

            // SCORE
            const score = sessionCopiedWords + 1;
            // total
            totalScore += score;
            localStorage.setItem('totalScore', totalScore);
            // session
            sessionScore += score;
            localStorage.setItem('sessionScore', sessionScore);
            // day
            dayScore += score;
            localStorage.setItem('dayScore', dayScore);
            // best session
            if (sessionScore > bestSessionScore) {
                bestSessionScore = sessionScore;
                localStorage.setItem('bestSessionScore', bestSessionScore);
            }
            // best day
            if (dayScore > bestDayScore) {
                bestDayScore = dayScore;
                localStorage.setItem('bestDayScore', bestDayScore);
            }

            // TIME
            const now = new Date();
            const elapsedSinceStart = Math.round((now.getTime() - sessionStart.getTime()) / 1000);
            const newElapsed = elapsedSinceStart - sessionTime;
            // total
            totalTime += newElapsed;
            localStorage.setItem('totalTime', totalTime);
            // session
            sessionTime += newElapsed;
            localStorage.setItem('sessionTime', sessionTime);
            // day
            dayTime += newElapsed;
            localStorage.setItem('dayTime', dayTime);
            // best session
            if (sessionTime > bestSessionTime) {
                bestSessionTime = sessionTime;
                localStorage.setItem('bestSessionTime', bestSessionTime);
            }
            // best day
            if (dayTime > bestDayTime) {
                bestDayTime = dayTime;
                localStorage.setItem('bestDayTime', bestDayTime);
            }
        }

        function onFinished() {
            push_word();
            m.play();
        }

        function start() {
            push_word();
            played.length = 0;
            copiedText = '';
            inSession = true;
            sessionStart = new Date();
            sessionDurationUpdater = setInterval(updateStats, 100);
            sessionCopiedCharacters = 0;
            sessionCopiedWords = 0;
            sessionScore = 0;
            sessionTime = 0;
            m.setWpm(settings.wpm);
            m.setEff(settings.wpm);
            m.setFreq(settings.tone);
            m.onFinished = onFinished;
            m.play();
            element_feedback.classList.add('success');
            element_feedback.classList.remove('failure');
            element_feedback_wrong_character.innerText = '';
            element_feedback_character.innerText = '';
            element_feedback_cw.innerText = '';
            element_info.innerText = '';
            element_feedback.focus();
            updateStats();
            updateHistory();
        }

        function stop(expected, user_input) {
            if (!inSession) {
                return;
            }

            const session = {
                id: self.crypto.randomUUID(),
                started: sessionStart.toISOString(),
                finished: new Date().toISOString(),
                copiedText: copiedText,
                mistake: !expected ? null : {
                    expected_character: expected,
                    mistaken_character: user_input,
                },
                settings: settings,
                copiedCharacters: sessionCopiedCharacters,
                copiedWords: sessionCopiedWords,
                score: sessionScore,
            };
            history.push(session);
            // NOTE: in the following scenario, the session from tab B will be lost
            // - open in tab A
            // - open in tab B
            // - play session in tab B
            // - play session in tab A
            localStorage.setItem('history', JSON.stringify(history));

            inSession = false;
            m.onFinished = undefined;
            updateStats();
            clearInterval(sessionDurationUpdater);
            sessionDurationUpdater = undefined;
            m.stop();
        }

        function replay_after_mistake(c) {
            m.onFinished = function() {
                m.onFinished = undefined;
                m.setFreq(settings.tone);
                if (c !== undefined) {
                    m.play(' ' + c);
                }
            };
            m.setFreq(settings.error_tone);
            m.play('T');
        }

        function character_to_string(c) {
            if (c === undefined) {
                return '-';
            } else if (c == ' ') {
                return 'Space';
            } else {
                return c;
            }
        }

        document.addEventListener('keydown', function(event) {
            const user_input = event.key.toLowerCase();

            // disable Firefox's quick search when pressing forward slash
            if (user_input == '/') {
                event.preventDefault();
            }

            // hitting space starts the keying
            if (!inSession && user_input == 'enter') {
                start();
            }

            // ignore other inputs when not in session
            if (!inSession) {
                return;
            }

            // stop space from scrolling the page while in session
            if (user_input == ' ') {
                event.preventDefault();
            }

            // stop when user hits Escape key
            if (user_input == 'escape') {
                stop();
            }

            // ignore non-copy user inputs (not in the charset, and not a space)
            if (user_input != ' ' && settings.charset.toLowerCase().indexOf(user_input) == -1) {
                return;
            }

            // played[nextIndex] is undefined if nextIndex >= played.length
            const expected = played[sessionCopiedCharacters]?.toLowerCase();
            if (user_input == expected) {
                // correct
                incrementCopiedCharacters(expected);
                updateHistory();
            } else {
                // incorrect
                stop(expected, user_input);
                replay_after_mistake(expected);
                element_feedback.classList.remove('success');
                element_feedback.classList.add('failure');
                element_feedback_wrong_character.innerText = character_to_string(user_input);
            }

            element_feedback_character.innerText = character_to_string(expected);
            element_feedback_cw.innerText = m.alphabet[expected] || '';
        })

        m.onCharacterPlay = function(c) {
            // skip leading space
            if (played.length == 0 && c.c == ' ') {
                return;
            }

            // add character
            played.push(c.c);

            // detect when user has stopped copying
            if (played.length - copiedText.length > 10) {
                element_info.innerText = 'Are you still there?';
                stop();
            }
        }

        element_feedback.addEventListener('blur', () => {
            element_info.innerText = 'Focus lost!';
            stop();
        });
        </script>
    </body>
</html>
