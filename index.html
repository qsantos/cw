<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Morse ðŸ˜º</title>
        <style>
        #feedback {
            width:200px;
            height:200px;
            margin: 0 auto;
            font-weight: bold;
            color: white;
            background-color: #3677b3;
            text-align: center;
        }
        #feedback.success {
            background-color: #36B37E;
        }
        #feedback.failure {
            background-color: #FF5630;
        }
        #feedback_wrong_character, #feedback_character {
            min-height: 1.25em;
            line-height: 1.25;
            font-variant-caps: small-caps;
            font-size: 50px;
            font-family: sans-serif;
        }
        #feedback_wrong_character {
            text-decoration: line-through;
        }
        #feedback_cw {
            font-size: 40px;
        }
        #copied {
            font-family: monospace;
            font-size: 20px;
            text-transform: uppercase;
            border:1px solid grey;
            height:200px;
            padding: 5px;
            margin: 15px;
            background-color:#fcf8f8;
        }
        </style>
        <script src="./jscwlib.js"></script>
    </head>
    <body>
        <h1>Morse ðŸ˜º</h1>
        <div id="copied"></div>
        <div id="info"></div>
        <div id="feedback">
            <div id="feedback_wrong_character">&nbsp;</div>
            <div id="feedback_character">&nbsp;</div>
            <div id="feedback_cw">&nbsp;</div>
        </div>
        <div id="stats"></div>
        <div id="lamp" style="width:20px; height:20px; border:1px solid black;"></div>
        <form id="settings">
            <label for="settings-wpm">Speed:</label>
            <input id="settings-wpm" oninput="update_settings()" type="number" value="20" min="1" step="0.5" />
            <abbr title="Words Per Minute">WPM</abbr>
            <br>
            <label for="settings-tone">Tone:</label>
            <input id="settings-tone" oninput="update_settings()" type="number" value="600" min="10" step="10" />
            Hz
            <br>
            <label for="settings-error-tone">Error Tone:</label>
            <input id="settings-error-tone" oninput="update_settings()" type="number" value="200" min="10" step="10" />
            Hz
            <br>
            <label for="settings-word-length">Size of words:</label>
            <input id="settings-word-length" oninput="update_settings()" type="number" value="5" min="1" />
            characters
            <br>
            <label for="settings-charset">Customize Charset:</label>
            <br>
            <textarea id="settings-charset" oninput="update_charset()">KMURESNAPTLWI.JZ=FOY,VG5/Q92H38B?47C1D60X</textarea>
            <br>
        </form>
        </form>
        <script>
        const settings = {
            wpm: 0,
            tone: 0,
            error_tone: 0,
            word_length: 0,
            charset: '',
        };

        const m = new jscw();

        function push_word() {
            const word = Array.from({length: settings.word_length}, () =>
                settings.charset[Math.floor(Math.random() * settings.charset.length)]
            ).join('');
            m.setText(' ' + word);
        }

        const played = [];
        let inSession = false;
        let sessionStart = undefined;
        let sessionDurationUpdater = undefined;

        // stats
        // CHARACTERS
        let totalCopiedCharacters = localStorage.getItem('totalCopiedCharacters') ^ 0;
        let sessionCopiedCharacters = 0;
        let bestSessionCopiedCharacters = localStorage.getItem('bestSessionCopiedCharacters') ^ 0;
        // WORDS
        let totalCopiedWords = localStorage.getItem('totalCopiedWords') ^ 0;
        let sessionCopiedWords = 0;
        let bestSessionCopiedWords = localStorage.getItem('bestSessionCopiedWords') ^ 0;
        // SCORE
        let totalScore = localStorage.getItem('totalScore') ^ 0;
        let sessionScore = 0;
        let bestSessionScore = localStorage.getItem('bestSessionScore') ^ 0;

        const copied = document.getElementById('copied');
        const progress = document.getElementById('progress');
        const feedback = document.getElementById('feedback');
        const feedback_wrong_character = document.getElementById('feedback_wrong_character');
        const feedback_character = document.getElementById('feedback_character');
        const feedback_cw = document.getElementById('feedback_cw');
        const stats = document.getElementById('stats');
        const info = document.getElementById('info');

        function update_settings() {
            stop();
            settings.wpm = document.getElementById('settings-wpm').value;
            settings.tone = document.getElementById('settings-tone').value;
            settings.error_tone = document.getElementById('settings-error-tone').value;
            settings.word_length = document.getElementById('settings-word-length').value;
            settings.charset = document.getElementById('settings-charset').value;
        }
        update_settings();

        function updateStats() {
            const sessionDuration = sessionStart === undefined ? 0 : Math.round((Date.now() - sessionStart) / 1000);
            stats.innerHTML = (
                'Practised for ' + sessionDuration + ' seconds<br>' +
                'Copied ' + sessionCopiedCharacters + ' characters (best: ' + bestSessionCopiedCharacters + ')<br>' +
                'Copied ' + totalCopiedCharacters + ' characters in total<br>' +
                'Copied ' + sessionCopiedWords + ' words (best: ' + bestSessionCopiedWords + ')<br>' +
                'Copied ' + totalCopiedWords + ' words in total<br>' +
                'Current score is ' + sessionScore + ' (best: ' + bestSessionScore + ')<br>' +
                'Total score is ' + totalScore + '<br>' +
                ''
            )
        }
        updateStats();

        function incrementCopiedCharacters(c) {
            // CHARACTERS
            // total
            totalCopiedCharacters += 1;
            localStorage.setItem('totalCopiedCharacters', totalCopiedCharacters)
            // session
            sessionCopiedCharacters += 1;
            // best session
            if (sessionCopiedCharacters > bestSessionCopiedCharacters) {
                bestSessionCopiedCharacters = sessionCopiedCharacters;
                localStorage.setItem('bestSessionCopiedCharacters', bestSessionCopiedCharacters)
            }

            // WORDS
            if (c == ' ') {
                // total
                totalCopiedWords += 1;
                localStorage.setItem('totalCopiedWords', totalCopiedWords);
                // session
                sessionCopiedWords += 1;
                // best session
                if (sessionCopiedWords > bestSessionCopiedWords) {
                    bestSessionCopiedWords = sessionCopiedWords;
                    localStorage.setItem('bestSessionCopiedWords', bestSessionCopiedWords);
                }
            }

            // SCORE
            // total
            totalScore += sessionCopiedWords + 1;
            localStorage.setItem('totalScore', totalScore);
            // session
            sessionScore += sessionCopiedWords + 1;
            // best score
            if (sessionScore > bestSessionScore) {
                bestSessionScore = sessionScore;
                localStorage.setItem('bestSessionScore', bestSessionScore);
            }
        }

        function onFinished() {
            push_word();
            m.play();
        }

        function start() {
            push_word();
            played.length = 0;
            inSession = true;
            sessionStart = Date.now();
            updateStats();
            sessionDurationUpdater = setInterval(updateStats, 100);
            sessionCopiedCharacters = 0;
            sessionCopiedWords = 0;
            sessionScore = 0;
            m.setWpm(settings.wpm);
            m.setEff(settings.wpm);
            m.setFreq(settings.tone);
            m.onFinished = onFinished;
            m.play();
            feedback.classList.add('success');
            feedback.classList.remove('failure');
            feedback_wrong_character.innerText = '';
            feedback_character.innerText = '';
            feedback_cw.innerText = '';
            info.innerText = '';
        }

        function stop() {
            if (!inSession) {
                return;
            }
            inSession = false;
            m.onFinished = undefined;
            updateStats();
            clearInterval(sessionDurationUpdater);
            sessionDurationUpdater = undefined;
            m.stop();
        }

        function replay_after_mistake(c) {
            m.onFinished = function() {
                m.onFinished = undefined;
                m.setFreq(settings.tone);
                if (c !== undefined) {
                    m.play(c);
                }
            };
            m.setFreq(settings.error_tone);
            m.play('T ');
        }

        function character_to_string(c) {
            if (c === undefined) {
                return '-';
            } else if (c == ' ') {
                return 'Space';
            } else {
                return c;
            }
        }

        document.addEventListener('keydown', function(event) {
            const user_input = event.key.toLowerCase();

            // disable Firefox's quick search when pressing forward slash
            if (user_input == '/') {
                event.preventDefault();
            }

            // hitting space starts the keying
            if (!inSession && user_input == 'enter') {
                start();
            }

            // ignore other inputs when not in session
            if (!inSession) {
                return;
            }

            // stop when user hits Escape key
            if (user_input == 'escape') {
                stop();
            }

            // ignore non-copy user inputs (not in the charset, and not a space)
            if (user_input != ' ' && settings.charset.indexOf(user_input) == -1) {
                return;
            }

            // played[nextIndex] is undefined if nextIndex >= played.length
            const expected = played[sessionCopiedCharacters]?.toLowerCase();
            if (user_input == expected) {
                // correct
                incrementCopiedCharacters(expected);
                copied.innerText = played.slice(0, sessionCopiedCharacters).join('');
            } else {
                // incorrect
                stop();
                replay_after_mistake(expected);
                feedback.classList.remove('success');
                feedback.classList.add('failure');
                feedback_wrong_character.innerText = character_to_string(user_input);
            }

            feedback_character.innerText = character_to_string(expected);
            feedback_cw.innerText = m.alphabet[expected] || '';
        })

        m.onCharacterPlay = function(c) {
            // skip leading space
            if (played.length == 0 && c.c == ' ') {
                return;
            }
            // add character
            played.push(c.c);
        }

        window.addEventListener('blur', () => {
            info.innerText = 'Focus lost!';
            stop();
        });
        window.focus();
        </script>
    </body>
</html>
